<!-- Auto-generated by Codex agent on 2025-12-01T00:27:00Z -->
# Quantization Tuning Plan

- Target machine: >=32GB RAM, NVMe scratch disk recommended for fast swap; run on a dedicated host (no local CI).
- Variants to test: `q4_0`, `q4_K_M`, `q4_KV`, `q8_0`, `q8_0-kv-hybrid` (skip automatically if the file is missing).
- Metrics to collect per run: `p50`, `p95`, `peak_rss`, `load_time_ms` (command duration), `obedience_pass_rate` (if available in result JSON), token throughput (if present), plus metadata (`variant`, `batch_size`, `warmups`, `runs`, `timestamp`).
- Run matrix: warmups = 3, runs = 20, batch sizes = {1, 4, 8}. Variants looped independently.
- Output format: JSON arrays under `quant_tuning/results/<variant>_YYYYMMDD.json` where each element is one run (variant + batch size).

## How to execute (remote 32GB+ host)
1) Copy models and repo to the target machine and activate the desired Python environment.
2) Run the bench loop (skips missing model files):
```bash
bash quant_tuning/run_quant_bench.sh
```
   - Override variants or batch sizes: `VARIANTS="q4_0 q8_0" BATCH_SIZES="1 4" bash quant_tuning/run_quant_bench.sh`
   - Dry-run of the loop logic (no special flag yet) is possible by cancelling after the first echo; the script only calls `bench/benchmark_model.py` which is lightweight compared to quantization.
3) Aggregate to CSV for quick review:
```bash
python quant_tuning/collect_results.py --results-dir quant_tuning/results --output-csv quant_tuning/summary.csv
```
4) Move `quant_tuning/results/` and `quant_tuning/summary.csv` off-box for analysis and attach to the PR if needed.

## Notes
- `bench/benchmark_model.py` produces `bench/bench_results.json`; the helper script copies/annotates that output with variant/batch size and stores it under `quant_tuning/results/`.
- Token throughput and obedience scores are included only if the underlying bench JSON already provides them (fields default to `null`).
- Keep warmups/runs consistent across variants to make the CSV comparable; adjust via `WARMUPS`/`RUNS` env vars if you need quicker spot-checks.
